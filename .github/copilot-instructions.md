# AI Agent Coding Instructions - Student Guitar App

## Project Overview
A React + Vite web application for managing student guitar lessons. Features: Google Auth, Firebase Firestore backend, role-based admin system, automated payment notifications (email/WhatsApp), and student profile management.

## Architecture

### Tech Stack
- **Frontend**: React 19, Vite 7, Tailwind CSS, React Router v7
- **Backend**: Firebase Auth + Firestore (cloud-hosted NoSQL)
- **Notifications**: notificationService.js (currently mocked, needs Cloud Functions integration)
- **State Management**: React Context API (AuthContext) + Zustand available (in deps)
- **Icons/UI**: lucide-react, Tailwind

### Data Flow & Key Components

**Auth Flow (Critical)**:
1. User clicks Login â†’ `loginWithGoogle()` in AuthContext
2. Firebase Auth confirms identity â†’ `syncUserProfile()` syncs to Firestore `users` collection
3. System checks `users/{email}.role` field:
   - If `role === 'admin'` â†’ redirect to `/admin`
   - If `role === 'user'` â†’ allowed to `/profile`
4. Non-authenticated users redirected to `/`

**Firestore Schema** (from context):
```javascript
users/{email} {
  email: string,
  displayName: string,
  phone: string,
  role: "admin" | "user",    // Critical: determines access
  status: "active",
  createdAt: timestamp
}
```

**Protected Routes** (see `App.jsx`):
- `PrivateRoute` wrapper checks `currentUser` and `userRole`
- `requireAdmin` prop enforces admin-only access on `/admin`

### Payment/Notification Workflow
When admin updates student's class count from 3â†’4:
1. Admin Panel triggers notification flow
2. `sendNotificationToStudent()` called with `{email: true, whatsapp: true}`
3. Sends identical message to **both student AND tutor** (for audit trail)
4. Currently logged to console; needs Firebase Functions integration

**Key Pattern**: Notifications always use `channels` object to control email/WhatsApp toggles (stored per student in Firestore).

## Developer Workflows

### Build & Run
```bash
npm run dev      # Start Vite dev server (HMR enabled)
npm run build    # Production build to dist/
npm run lint     # ESLint check (src/, eslint.config.js)
npm run preview  # Preview built output locally
```

### Testing Flow
- No test suite currently configured
- Use browser console + FirebaseDebugPanel (AdminDebugPanel.jsx) to inspect auth state
- Firestore rules in `firestore.rules` govern read/write access

### Firebase Setup
- Config in `src/firebase.js` (hardcoded, should move to env vars for production)
- Indexes in `firestore.indexes.json` (auto-generated by Firebase)
- Rules in `firestore.rules` (deploy via `firebase deploy`)

## Project-Specific Patterns & Conventions

### Context API Usage
```jsx
// Always import useAuth hook, not createContext directly
const { currentUser, userRole, loading } = useAuth();
// currentUser = null before auth; userRole = null before Firestore sync
// loading = false when not actively fetching (doesn't block UI)
```

### Trace/Debug Pattern
AuthContext includes `trace` state (visible in dev tools) to debug login flow. Set via `setTrace()` callsâ€”useful for debugging auth failures without console logs.

### Notification Conventions
- `sendNotificationToStudent(student, message, {email: bool, whatsapp: bool})`
- Always send to tutor's CC email (not yet implemented; see TODO in NOTIFICATION_SETUP.md)
- Messages are **not templated client-side**â€”should be generated by Cloud Functions

### Role-Based Conditional Rendering
```jsx
// In components, check userRole before showing admin UI
{userRole === 'admin' && <AdminPanel />}
// Header shows ðŸ”´ ADMIN or âšª User badge
```

## Critical Integration Points

### Firebase Rules (firestore.rules)
- **Read**: Only admins or own user doc; students see own profile only
- **Write**: Carefulâ€”admins can write user.role; students cannot
- Rules enforce role boundaries; changes require `firebase deploy`

### Notification Service Mocking
`notificationService.js` currently logs to console. Production needs:
1. Firebase Cloud Functions endpoints: `sendEmail()`, `sendWhatsApp()`
2. Integration with Twilio (WhatsApp) or Sendgrid/Gmail (email)
3. Call from admin actions (e.g., payment reminder trigger)

### Admin Panel (src/pages/Admin.jsx)
- Tabs: "Students", "Users & Admins", others (see ADMIN_IMPLEMENTATION.md)
- Students Tab: List from Firestore, update class count, trigger notifications
- Users & Admins Tab: Change `role` field via settings button (gear icon)
- Must check that logged-in user is admin before rendering (PrivateRoute guards this)

## Common Workflows

### Adding New Admin Features
1. Check PrivateRoute in App.jsx allows access
2. Write in `/pages/Admin.jsx` or new component
3. Query Firestore from component (import `db` from firebase.js)
4. For notifications, call `sendNotificationToStudent()` with student doc
5. Update `ADMIN_IMPLEMENTATION.md` if new admin feature added

### Modifying User Role
- Edit Firestore `users/{email}.role` field to "admin" or "user"
- AuthContext re-syncs on next page load (uses `onAuthStateChanged`)
- User loses `/admin` access immediately if demoted

### Firestore Queries
```javascript
import { db } from '../firebase';
import { collection, query, where, getDocs, doc, updateDoc } from 'firebase/firestore';

// Fetch all students
const usersRef = collection(db, 'users');
const q = query(usersRef, where('role', '==', 'user'));
const snapshot = await getDocs(q);

// Update role
await updateDoc(doc(db, 'users', email), { role: 'admin' });
```

## Key Files & Their Roles

| File | Purpose |
|------|---------|
| [src/App.jsx](src/App.jsx) | Route definitions, PrivateRoute protection |
| [src/contexts/AuthContext.jsx](src/contexts/AuthContext.jsx) | Global auth state, login/signup, role sync |
| [src/firebase.js](src/firebase.js) | Firebase config, db/auth exports |
| [src/pages/Admin.jsx](src/pages/Admin.jsx) | Admin panel UI, student/user management |
| [src/services/notificationService.js](src/services/notificationService.js) | Notification templates (mocked; needs Cloud Functions) |
| [firestore.rules](firestore.rules) | Security rules; must deploy changes |
| [ADMIN_IMPLEMENTATION.md](ADMIN_IMPLEMENTATION.md) | Admin feature specs (reference for new features) |

## Known Constraints & TODOs
- Notifications are mocked (console.log); need Firebase Functions + Twilio/Sendgrid
- Environment variables not configured; Firebase config hardcoded in `src/firebase.js`
- No TypeScript; consider for scalability
- Zustand imported but unusedâ€”consider for complex state (e.g., multi-page admin workflows)
- No E2E tests; add before production
